<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Graphique - DHT11</title>

    <!-- amCharts Resources -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3498db;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #3498db;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .controls-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .control-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 12px 28px;
            background: #ecf0f1;
            border: 2px solid transparent;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        .period-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .stats-bar {
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3498db;
        }

        .stat-item-label {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        #chartdiv {
            width: 100%;
            height: 600px;
        }

        .loading {
            text-align: center;
            padding: 100px;
            color: #3498db;
            font-size: 1.3rem;
        }

        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .button-group {
                flex-direction: column;
            }

            .period-btn {
                width: 100%;
            }

            #chartdiv {
                height: 400px;
            }

            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">üå°Ô∏è DHT11 Monitor</a>
            <ul class="nav-links">
                <li><a href="/">Accueil</a></li>
                <li><a href="/dashboard/">Tableau de Bord</a></li>
                <li><a href="/charts/">Graphiques</a></li>
                <li><a href="/all-data/">Donn√©es</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Analyse Graphique</h1>
            <p class="page-subtitle">Visualisation interactive de la temp√©rature et de l'humidit√©</p>
        </div>

        <div class="controls-section">
            <div class="control-label">S√©lectionner la p√©riode d'analyse</div>
            <div class="button-group">
                <button class="period-btn active" onclick="loadData('all', this)">Toutes les donn√©es</button>
                <button class="period-btn" onclick="loadData('jour', this)">Derni√®res 24 heures</button>
                <button class="period-btn" onclick="loadData('semaine', this)">7 derniers jours</button>
                <button class="period-btn" onclick="loadData('mois', this)">30 derniers jours</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-item-value" id="data-count">--</div>
                <div class="stat-item-label">Points de donn√©es</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-value" id="period-label">Toutes</div>
                <div class="stat-item-label">P√©riode affich√©e</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-value" id="avg-temp">--¬∞C</div>
                <div class="stat-item-label">Temp√©rature moyenne</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-value" id="avg-hum">--%</div>
                <div class="stat-item-label">Humidit√© moyenne</div>
            </div>
        </div>

        <div class="chart-container">
            <div id="chartdiv"></div>
        </div>
    </div>

    <script>
        let root;
        let chart;

        function loadData(period, buttonElement) {
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Update period label
            const periodLabels = {
                'all': 'Toutes',
                'jour': '24h',
                'semaine': '7 jours',
                'mois': '30 jours'
            };
            document.getElementById('period-label').textContent = periodLabels[period];

            // Define URL
            let url = '/api/chart-data/';
            if (period === 'jour') url = '/api/chart-data-jour/';
            if (period === 'semaine') url = '/api/chart-data-semaine/';
            if (period === 'mois') url = '/api/chart-data-mois/';

            // Show loading
            const chartDiv = document.getElementById('chartdiv');
            chartDiv.innerHTML = '<div class="loading">‚è≥ Chargement des donn√©es...</div>';

            // Fetch data
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    chartDiv.innerHTML = '';
                    createChart(data);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    chartDiv.innerHTML = '<div class="loading" style="color: red;">‚ùå Erreur de chargement</div>';
                });
        }

        function createChart(data) {
            // Dispose previous chart
            if (root) {
                root.dispose();
            }

            // Calculate statistics
            const temps = data.temperature;
            const hums = data.humidity;
            const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1);
            const avgHum = (hums.reduce((a, b) => a + b, 0) / hums.length).toFixed(1);

            document.getElementById('data-count').textContent = data.temps.length;
            document.getElementById('avg-temp').textContent = avgTemp + '¬∞C';
            document.getElementById('avg-hum').textContent = avgHum + '%';

            // Transform data - create separate temperature and humidity series
            const chartData = data.temps.map((timestamp, index) => ({
                date: new Date(timestamp).getTime(),
                temperature: data.temperature[index],
                humidity: data.humidity[index]
            }));

            // Create root
            root = am5.Root.new("chartdiv");

            // Set themes
            root.setThemes([
                am5themes_Animated.new(root)
            ]);

            // Create chart
            chart = root.container.children.push(
                am5xy.XYChart.new(root, {
                    panX: true,
                    panY: true,
                    wheelX: "panX",
                    wheelY: "zoomX",
                    pinchZoomX: true
                })
            );

            chart.get("colors").set("step", 2);

            // Add cursor
            const cursor = chart.set("cursor", am5xy.XYCursor.new(root, {
                behavior: "none"
            }));
            cursor.lineY.set("visible", false);

            // Create X-axis
            const xAxis = chart.xAxes.push(
                am5xy.DateAxis.new(root, {
                    baseInterval: { timeUnit: "minute", count: 1 },
                    renderer: am5xy.AxisRendererX.new(root, {
                        minorGridEnabled: true,
                        minGridDistance: 70
                    }),
                    tooltip: am5.Tooltip.new(root, {})
                })
            );

            // Create Y-axis
            const yAxis = chart.yAxes.push(
                am5xy.ValueAxis.new(root, {
                    renderer: am5xy.AxisRendererY.new(root, {})
                })
            );

            // Temperature series (like series1 in your example)
            const tempSeries = chart.series.push(
                am5xy.LineSeries.new(root, {
                    name: "Temp√©rature",
                    xAxis: xAxis,
                    yAxis: yAxis,
                    valueYField: "temperature",
                    openValueYField: "humidity",
                    valueXField: "date",
                    stroke: root.interfaceColors.get("positive"),
                    fill: root.interfaceColors.get("positive"),
                    tooltip: am5.Tooltip.new(root, {
                        labelText: "üå°Ô∏è {valueY}¬∞C"
                    })
                })
            );

            tempSeries.fills.template.setAll({
                fillOpacity: 0.6,
                visible: true
            });

            // Humidity series (like series2 in your example)
            const humSeries = chart.series.push(
                am5xy.LineSeries.new(root, {
                    name: "Humidit√©",
                    xAxis: xAxis,
                    yAxis: yAxis,
                    valueYField: "humidity",
                    valueXField: "date",
                    stroke: root.interfaceColors.get("negative"),
                    fill: root.interfaceColors.get("negative"),
                    tooltip: am5.Tooltip.new(root, {
                        labelText: "üíß {valueY}%"
                    })
                })
            );

            // Add scrollbar
            chart.set("scrollbarX", am5.Scrollbar.new(root, {
                orientation: "horizontal"
            }));

            // Set data
            tempSeries.data.setAll(chartData);
            humSeries.data.setAll(chartData);

            // Create ranges for area fills
            let i = 0;
            const baseInterval = xAxis.get("baseInterval");
            const baseDuration = xAxis.baseDuration();
            let rangeDataItem;

            am5.array.each(tempSeries.dataItems, function(tempDataItem) {
                let tempPreviousDataItem;
                let humPreviousDataItem;
                const humDataItem = humSeries.dataItems[i];

                if (i > 0) {
                    tempPreviousDataItem = tempSeries.dataItems[i - 1];
                    humPreviousDataItem = humSeries.dataItems[i - 1];
                }

                let startTime = am5.time.round(
                    new Date(tempDataItem.get("valueX")),
                    baseInterval.timeUnit,
                    baseInterval.count
                ).getTime();

                // Check intersections
                if (tempPreviousDataItem && humPreviousDataItem) {
                    const x0 = am5.time.round(
                        new Date(tempPreviousDataItem.get("valueX")),
                        baseInterval.timeUnit,
                        baseInterval.count
                    ).getTime() + baseDuration / 2;

                    const y01 = tempPreviousDataItem.get("valueY");
                    const y02 = humPreviousDataItem.get("valueY");
                    const x1 = startTime + baseDuration / 2;
                    const y11 = tempDataItem.get("valueY");
                    const y12 = humDataItem.get("valueY");

                    const intersection = getLineIntersection(
                        { x: x0, y: y01 },
                        { x: x1, y: y11 },
                        { x: x0, y: y02 },
                        { x: x1, y: y12 }
                    );

                    startTime = Math.round(intersection.x);
                }

                // Start range when humidity > temperature
                if (humDataItem.get("valueY") > tempDataItem.get("valueY")) {
                    if (!rangeDataItem) {
                        rangeDataItem = xAxis.makeDataItem({});
                        const range = tempSeries.createAxisRange(rangeDataItem);
                        rangeDataItem.set("value", startTime);
                        range.fills.template.setAll({
                            fill: humSeries.get("fill"),
                            fillOpacity: 0.6,
                            visible: true
                        });
                        range.strokes.template.setAll({
                            stroke: tempSeries.get("stroke"),
                            strokeWidth: 1
                        });
                    }
                } else {
                    if (rangeDataItem) {
                        rangeDataItem.set("endValue", startTime);
                    }
                    rangeDataItem = undefined;
                }

                // End if last
                if (i == tempSeries.dataItems.length - 1) {
                    if (rangeDataItem) {
                        rangeDataItem.set("endValue", tempDataItem.get("valueX") + baseDuration / 2);
                        rangeDataItem = undefined;
                    }
                }

                i++;
            });

            // Animate
            tempSeries.appear(1000);
            humSeries.appear(1000);
            chart.appear(1000, 100);
        }

        function getLineIntersection(pointA1, pointA2, pointB1, pointB2) {
            let x = ((pointA1.x * pointA2.y - pointA2.x * pointA1.y) * (pointB1.x - pointB2.x) -
                    (pointA1.x - pointA2.x) * (pointB1.x * pointB2.y - pointB1.y * pointB2.x)) /
                   ((pointA1.x - pointA2.x) * (pointB1.y - pointB2.y) -
                    (pointA1.y - pointA2.y) * (pointB1.x - pointB2.x));

            let y = ((pointA1.x * pointA2.y - pointA2.x * pointA1.y) * (pointB1.y - pointB2.y) -
                    (pointA1.y - pointA2.y) * (pointB1.x * pointB2.y - pointB1.y * pointB2.x)) /
                   ((pointA1.x - pointA2.x) * (pointB1.y - pointB2.y) -
                    (pointA1.y - pointA2.y) * (pointB1.x - pointB2.x));

            return { x: x, y: y };
        }

        // Load all data on startup
        window.addEventListener('load', function() {
            loadData('all');
        });
    </script>
</body>
</html>